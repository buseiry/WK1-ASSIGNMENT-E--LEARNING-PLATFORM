<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sign In â€¢ Reading Streak</title>
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<!-- Tailwind built CSS -->
	<link rel="stylesheet" href="./styles/output.css">
	<link rel="stylesheet" href="./styles.css">
	<meta name="description" content="Login or register to start tracking your reading sessions">
</head>
<body>
    <script src="./layout.js"></script>
	<header class="navbar">
		<div class="container">
			<div class="nav-brand">
				<h1>ðŸ“š Reading Streak</h1>
			</div>
			<nav class="nav-links">
				<a href="./index.html" class="nav-link">Home</a>
				<a href="./leaderboard.html" class="nav-link">Leaderboard</a>
				<a href="./payment.html" class="nav-link">Payment</a>
			</nav>
		</div>
	</header>

	<main class="container max-w-7xl mx-auto px-6">
		<section class="section active">
			<div class="section-header">
				<h2>Welcome back</h2>
				<p>Login or create an account to continue</p>
			</div>

			<div class="dashboard-grid grid grid-cols-1 md:grid-cols-2 gap-6">
				<div class="stats-card bg-white rounded-2xl shadow-md border border-gray-100 p-6">
					<h3>Login</h3>
					<form id="login-form" class="auth-form">
						<div class="form-group">
							<label for="login-email">Email</label>
							<input id="login-email" type="email" placeholder="you@example.com" required>
						</div>
						<div class="form-group">
							<label for="login-password">Password</label>
							<input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
						</div>
						<button id="login-btn" type="submit" class="btn btn-primary">Sign In</button>
					</form>
				</div>

				<div class="stats-card bg-white rounded-2xl shadow-md border border-gray-100 p-6">
					<h3>Create account</h3>
					<form id="register-form" class="auth-form">
						<div class="form-group">
							<label for="register-email">Email</label>
							<input id="register-email" type="email" placeholder="you@example.com" required>
						</div>
						<div class="form-group">
							<label for="register-password">Password</label>
							<input id="register-password" type="password" placeholder="At least 6 characters" required>
						</div>
						<button id="register-btn" type="submit" class="btn btn-outline">Create Account</button>
					</form>
				</div>
			</div>

			<div id="status-container" class="status-container"></div>
		</section>
	</main>

	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-functions-compat.js"></script>
	<script src="./firebase-config.js"></script>
	<script>
	(function(){
		const auth = window.firebaseAuth;
		const db = window.firebaseDb;

		function showStatus(message, type = 'info') {
			const container = document.getElementById('status-container');
			if (!container) return;
			const el = document.createElement('div');
			el.className = `status ${type}`;
			el.textContent = message;
			container.appendChild(el);
			setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 5000);
		}

		// If already signed in, redirect to dashboard/session
		auth.onAuthStateChanged(async (user) => {
			if (user) {
				try {
					const userDoc = await db.collection('users').doc(user.uid).get();
					const hasPaid = !!(userDoc.exists && (userDoc.data().hasPaid || userDoc.data().paymentStatus));
					// If there is an active session, go to session page; else dashboard
					const sessionDoc = await db.collection('sessions').doc(user.uid).get();
					if (sessionDoc.exists && sessionDoc.data().startedAt && !sessionDoc.data().completed) {
						window.location.href = './session.html';
						return;
					}
					window.location.href = hasPaid ? './dashboard.html' : './payment.html';
				} catch (e) {
					console.warn('Post-login redirect failed, sending to dashboard', e);
					window.location.href = './dashboard.html';
				}
			}
		});

		// Login handler
		document.getElementById('login-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const email = (document.getElementById('login-email').value || '').trim();
			const password = document.getElementById('login-password').value;
			try {
				await auth.signInWithEmailAndPassword(email, password);
				showStatus('Login successful!', 'success');
			} catch (err) {
				showStatus(err.message || 'Login failed', 'error');
			}
		});

		// Register handler
		document.getElementById('register-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const email = (document.getElementById('register-email').value || '').trim();
			const password = document.getElementById('register-password').value;
			try {
				await auth.createUserWithEmailAndPassword(email, password);
				showStatus('Account created! Please verify your email.', 'success');
				try { await auth.currentUser.sendEmailVerification(); } catch(_) {}
			} catch (err) {
				showStatus(err.message || 'Registration failed', 'error');
			}
		});
	})();
	</script>
</body>
</html>


